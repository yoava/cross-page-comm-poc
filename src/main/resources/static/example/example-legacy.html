<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="X-UA-Compatible" content="IE=EmulateIE7"/>
    <meta charset="utf-8">
    <title>Hermy Example:: Legacy App</title>
    <link href="example.css" rel="stylesheet" type="text/css"/>
    <script type="text/javascript" src="/hermy/lib/jquery-1.9.0.js"></script>
    <script type="text/javascript" src="/hermy/webjars/atmosphere-javascript/2.3.2/atmosphere.js"></script>
    <script type="text/javascript" src="/hermy/lib/hermy-0.1.js"></script>
    <script>
        $(function () {
            // create HermyClient
            var channel = new HermyClient('yoava')   // use default config and 'yoava' as a tokenSeed
                    .channel('legacy')               // get messages send to 'legacy'
                    .with('angularjs');              // send messages to 'angularjs'

            channel
            // show Edit User dialog when receiving 'editUser' message
                    .on('editUser', function (user) {
                        $('#userDialog').removeClass('hidden');
                        $('#userId').html(user.id);
                        $('#username').val(user.name);
                        window.focus();
                    })

                    // log all messages
                    .on(logMessage)
                    .on('$connected', 'legacy', logMessage);


            // send message back to angularjs when editing is done
            $('#submitButton').click(function () {
                $('#userDialog').addClass('hidden');
                channel.send('userChanged', {
                    id: parseInt($('#userId').html()),
                    name: $('#username').val()
                });
            });

            function logMessage(message, metadata) {
                console.info('Got message', message, metadata);

                var body = atmosphere.util.stringifyJSON(message);
                $('#messages').append(
                        '<div class="message">' +
                        '<span class="field">from</span>' +
                        '<span class="value">' + metadata.$from + '</span>' +
                        '<span class="field">type</span>' +
                        '<span class="value">' + metadata.$type + '</span>' +
                        '<span class="field">body</span>' +
                        '<span class="value">' + body + '</span>' +
                        '</div>')
            }
        });
    </script>
</head>
<body>

<h1>Legacy App</h1>

<p>Waiting for edit command for AngularJS app...</p>

<div id="userDialog" class="editUser hidden">
    <h3>Editing user #<span id="userId"></span></h3>
    <label for="username">Username:</label><input id="username" type="text">
    <button id="submitButton">Done</button>
</div>

<h3 class="title">Hermy Log:</h3>
<div id="messages" class="log"></div>

</body>
</html>
